#!/usr/bin/env -S uvx --from git+https://github.com/varlabz/ask ask-run

# your own custom agent for personal mentoring and growth
# will help you think better, act more consistently, and grow intentionally over time

# it keeps your notes in ~/basic-memory-mentor, change path in create_project if needed

# mentor will save notes after each conversation and keep in your file system
# mentor keep your notes locally, never share them online

# Ask yourself:
# Where do I want to improve or grow?
# What kind of guidance do I wish I had daily?

# Common areas:
# Mental clarity and emotional regulation
# Career focus and decision-making
# Health, fitness, and energy
# Self-discipline and consistency
# Confidence and communication

# Start simple:
# Morning: “What should I prioritize today?”
# Evening: “What did I learn from today’s discomfort?”
# Weekly: “Where did I drift from my values?”
# Decisions: “Help me think through this dilemma.”
# Self-doubt: “Challenge this belief I’m struggling with.”

# Upgrade It Over Time
# Use persistent threads to keep memory-like context
# Teach it to your recurring goals, language, and habits
# Let it help you spot patterns, triggers, and blind spots
# Even ask: “How would I have responded to this a year ago?”
# You’re building a living feedback loop — one that sharpens you every time you use it.

import argparse
import asyncio
from datetime import date, datetime, timedelta
import os
import sys
from pathlib import Path
from textwrap import dedent
from typing import Final
from pydantic import BaseModel, Field

from ask.core import tchat
from ask.core.agent import AgentASK
from ask.core.config import LLMConfig, TraceConfig, load_config, load_config_dict
from ask.core.instrumentation import setup_instrumentation_config
from ask.core.memory import NoMemory
from ask.core.memory_history import History

llm = load_config(["~/.config/ask/llm-ollama.yaml"], type=LLMConfig, key="llm")
# comment to disable trace. currently it works only with langfuse
setup_instrumentation_config(load_config(["~/.config/ask/trace.yaml"], type=TraceConfig, key="trace"), )

history = History()

mentor_agent = AgentASK.create_from_dict({
    "agent": {
        "name": "Mentor",
        "instructions": dedent(f"""
            You are now my Mentor — a dedicated, insightful, and challenging guide focused on my personal growth across mental clarity, 
            discipline, mindset, career, health, and emotional intelligence.

            Your core mission is to help me think better, act more consistently, and grow intentionally over time.

            ROLE & PERSONALITY
            - Act like a cross between a trusted executive coach, a rational Stoic, and a compassionate psychologist.
            - Prioritize truth, clarity, and growth over comfort or flattery.
            - Hold me accountable when I drift or make excuses.
            - Be direct when needed, supportive when I’m struggling, and always growth-oriented.

            CONTEXT TO REMEMBER
            - I value deep thinking, strategic action, and sustainable self-improvement.

            RULES OF ENGAGEMENT
            - Ask thoughtful questions before giving answers.
            - Help me explore second- and third-order consequences of my decisions.
            - Track recurring themes, patterns, and progress (if shared in ongoing threads).
            - Prompt weekly reviews, reflections, and updates.
            - Suggest tools, mental models, or books if relevant, but don’t overwhelm me.

            TONE & FORMAT
            - Clear, concise, human-sounding.
            - Use structure when helpful (e.g., lists, pros and cons, reflections).
            - Occasionally reframe things to challenge limiting beliefs or blind spots.
            - Always end with a question to keep me engaged and thinking.
            - Give practical, actionable advice I can implement immediately.
            - Don't repeat yourself unnecessarily.
            - Don't mention you are an AI model.
            - Don't give any other answers not related to mentoring me for personal growth.
            
            TOOLS:
            - Use history get page tool to get specific pages from history based on timestamp with page size 15.
            - Use timestamp tool to get current date and time.
        """),
    },
    "llm": llm,
}, NoMemory(), [history.get_timestamp, history.get_page, history.clear])

async def _main_func(input: str) -> str:
    res = await mentor_agent._iter(input)()
    history.add_history(input, res)
    return res

main_agent = AgentASK[str, str].create_from_function("Main", _main_func)

async def run_tchat(prompt: str|None):
    return await main_agent.run_iter(lambda: 
        mentor_agent.run_iter(lambda: 
            tchat.chat(main_agent, prompt if prompt else None)
        )
    )

async def main():
    """Main function for the mentor CLI."""
    parser = argparse.ArgumentParser(description="Mentor")
    # fmt: off
    parser.add_argument(
        "-T",
        "--tchat",
        action="store_true",
        help="Start terminal interactive chat mode",
    )
    parser.add_argument(
        "prompt", 
        nargs="*", 
        help="Prompt for the agent"
    )
    # fmt: on
    args = parser.parse_args()

    # can't use chat and not istty the same time
    if args.tchat and not sys.stdin.isatty():
        print("Error: Interactive chat mode requires a terminal.", file=sys.stderr)
        sys.exit(1)

    # Get prompt from args or stdin
    prompt = " ".join(args.prompt).strip()
    if not prompt and not sys.stdin.isatty():
        prompt = sys.stdin.read().strip()
        
    if args.tchat:
        return await run_tchat(prompt)

    if not prompt:
        print("Error: No prompt provided.", file=sys.stderr)
        parser.print_help(file=sys.stderr)
        sys.exit(1)

    result = await main_agent.run(prompt)
    print(result)


if __name__ == "__main__":
    asyncio.run(main())
